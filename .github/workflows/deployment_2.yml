name: Deployment2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: splunk 
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy repository files to all servers
        run: |
          # Save SSH key from secret
          echo "${{ secrets.SERVER_SSH_KEY }}" > id_rsa
          chmod 600 id_rsa

          # Split hosts by comma and loop
          for entry in $(echo "${{ secrets.DEPLOY_TARGETS }}" | tr "," "\n"); do
            host=$(echo $entry | cut -d: -f1)
            port=$(echo $entry | cut -d: -f2)
            
            echo "$host : $port"

            echo "üöÄ Ensuring target directory (/var/splunk) exists on $host..."
            # Create the directory /var/splunk on the remote server using SSH
            # ssh -i id_rsa -o StrictHostKeyChecking=no -p $port \
            #   ${{ secrets.SERVER_USER }}@$host \
            #   "mkdir -p /var/splunk"
            
            # if [ $? -ne 0 ]; then
            #   echo "‚ùå Failed to create target directory on $host. Skipping deployment."
            #   continue
            # fi

            echo "Deploying files from repository root to $host on port $port..."
            # **CORRECTED:** The './*' transfers all files/folders from the repository root.
            scp -i id_rsa -o StrictHostKeyChecking=no -P $port -r ./* \
              ${{ secrets.SERVER_USER }}@$host:/home/splunk/
            
            # --- Deployment Check ---
            if [ $? -eq 0 ]; then
              echo "‚úÖ Deployment to $host was **SUCCESSFUL**."
            else
              echo "‚ùå Deployment to $host **FAILED**."
              exit 1 
            fi
            # ------------------------
          done
