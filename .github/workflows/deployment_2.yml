name: Deployment

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # üåü Accesses secrets and required variables stored in the 'splunk' environment
    environment: splunk 
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy to all servers
        run: |
          # The secrets are now available here!
          # Save SSH key from secret
          echo "${{ secrets.SERVER_SSH_KEY }}" > id_rsa
          chmod 600 id_rsa

          # Split hosts by comma and loop
          for entry in $(echo "${{ secrets.DEPLOY_TARGETS }}" | tr "," "\n"); do
            host=$(echo $entry | cut -d: -f1)
            port=$(echo $entry | cut -d: -f2)
            
            echo "$host : $port"

            echo "üöÄ Ensuring target directory (/var/splunk) exists on $host..."
            # Create the directory /var/splunk on the remote server using SSH
            ssh -i id_rsa -o StrictHostKeyChecking=no -p $port \
              ${{ secrets.SERVER_USER }}@$host \
              "mkdir -p /var/splunk"
            
            if [ $? -ne 0 ]; then
              echo "‚ùå Failed to create target directory on $host. Skipping deployment."
              continue
            fi

            echo "Deploying to $host on port $port..."
            # SCP files to the /var/splunk directory
            scp -i id_rsa -o StrictHostKeyChecking=no -P $port -r ./dist/* \
              ${{ secrets.SERVER_USER }}@$host:/var/splunk/
            
            # --- Deployment Check ---
            if [ $? -eq 0 ]; then
              echo "‚úÖ Deployment to $host was **SUCCESSFUL**."
            else
              echo "‚ùå Deployment to $host **FAILED**."
              exit 1 
            fi
            # ------------------------
          done
